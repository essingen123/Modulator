!function(t){function e(n){if(s[n])return s[n].exports;var o=s[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,e),o.l=!0,o.exports}var s={};e.m=t,e.c=s,e.d=function(t,s,n){e.o(t,s)||Object.defineProperty(t,s,{configurable:!1,enumerable:!0,get:n})},e.n=function(t){var s=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(s,"a",s),s},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=9)}([function(t,e,s){"use strict";function n(t,e){return Math.log(e)/Math.log(t)}e.d=function(t,e){const s=t.indexOf(e);return!(s<0||(t.splice(s,1),0))},e.b=function(t,e,s){const a=n(o,s+1-e);return n(o,t+1-e)/a},e.c=function(t,e,s){const a=n(o,s+1-e);return e+Math.pow(o,t*a)-1},e.a=function(t){for(;null!=t&&t.tabIndex<0&&"body"!=t.nodeName.toLowerCase();)t=t.parentElement;return t};const o=2},function(t,e,s){"use strict";function n(t,e,s){if(!t.target.files||t.target.files.length<=0)return e(null);const n=t.target.files[0],o=new FileReader;o.onload=(t=>e(t.target.result,n)),o[s](n)}e.a=function(t){for(var e="",s=new Uint8Array(t),n=s.byteLength,o=0;o<n;o++)e+=String.fromCharCode(s[o]);return window.btoa(e)},e.b=function(t){for(var e=window.atob(t),s=e.length,n=new Uint8Array(s),o=0;o<s;o++)n[o]=e.charCodeAt(o);return n.buffer},e.c=function(){return!window.externalHost&&"download"in $("<a>")[0]},e.d=function(t,e){const s=$("<a>");s.attr("download",t),s.attr("href","data:application/octet-stream;base64,"+btoa(e));const n=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});s[0].dispatchEvent(n)},e.f=function(t,e){n(t,e,"readAsText")},e.e=function(t,e){n(t,e,"readAsArrayBuffer")}},function(t,e,s){"use strict";var n=s(4),o=s(5),a=s(0),i=s(6),r=s(1);const c=Math.pow(2,1/12),h=57;e.a=class{constructor(){this.isOut=!1}getInputs(){throw"Error: getInputs() function should be implemented by user"}};class d{constructor(){this.time=0,this.ratio=0}}e.b=class{constructor(t){this.customNodes={},this.paramHandlers={},this.noteHandlers=[],this.portamento=new d,this.ac=t,this.palette=o.a,this.registerCustomNode("createADSR",i.a),this.registerCustomNode("createNoise",i.e),this.registerCustomNode("createNoiseCtrl",i.d),this.registerCustomNode("createLineIn",i.c),this.registerCustomNode("createDetuner",i.b),this.registerParamHandler("BufferDataHandler",new class{constructor(){this.uiRender="renderBufferData"}initialize(t,e){}param2json(t){return r.a(t._encoded)}json2param(t,e){const s=r.b(e);t._encoded=s,t.context.decodeAudioData(s,e=>t._buffer=e)}}),this.registerParamHandler("SoundBankHandler",new class{constructor(){this.uiRender="renderSoundBank"}initialize(t,e){t._buffers=[],t._encodedBuffers=[],t._names=[]}param2json(t){const e=[],s=t._encodedBuffers,n=t._names;for(let t=0;t<n.length;t++)e.push({name:n[t],data:r.a(s[t])});return e}json2param(t,e){const s=t._buffers;s.length=0;const n=t._encodedBuffers;n.length=0;const o=t._names;o.length=0;for(let a=0;a<e.length;a++){const i=e[a];o.push(i.name);const c=r.b(i.data);n.push(c),this.decodeBuffer(t,c,s,a)}}decodeBuffer(t,e,s,n){t.context.decodeAudioData(e,t=>s[n]=t)}})}createAudioNode(t){const e=o.a[t];if(!e)return null;const s=e.custom?this.customNodes:this.ac;if(!s[e.constructor])return null;const n=s[e.constructor]();return n.context||(n.context=this.ac),this.initNodeParams(n,e,t),n}initNodeData(t,e){if(t.synth=this,t.type=e,t.anode=this.createAudioNode(e),!t.anode)return console.error(`No AudioNode found for '${e}'`);t.nodeDef=this.palette[e];const s=t.nodeDef.noteHandler;s&&(t.noteHandler=new n.a[s](t),this.addNoteHandler(t.noteHandler))}initOutputNodeData(t,e){t.synth=this,t.type="out",t.anode=this.ac.createGain(),t.anode.connect(e),t.nodeDef=this.palette.Speaker,t.isOut=!0}removeNodeData(t){t.noteHandler&&this.removeNoteHandler(t.noteHandler)}connectNodes(t,e){t.nodeDef.control&&!e.nodeDef.control?(t.controlParams=Object.keys(e.nodeDef.params).filter(t=>e.anode[t]instanceof AudioParam),t.controlParam=t.controlParams[0],t.controlTarget=e.anode,t.anode.connect(e.anode[t.controlParam])):t.anode.connect(e.anode)}disconnectNodes(t,e){t.nodeDef.control&&!e.nodeDef.control?(t.controlParams=null,t.anode.disconnect(e.anode[t.controlParam])):t.anode.disconnect(e.anode)}json2NodeData(t,e){for(const s of Object.keys(t.params)){const n=e.anode[s],o=t.params[s];e.nodeDef.params[s].handler?this.paramHandlers[e.nodeDef.params[s].handler].json2param(e.anode,o):n instanceof AudioParam?(n.value=o,n._value=o):e.anode[s]=o}}nodeData2json(t){const e={};for(const s of Object.keys(t.nodeDef.params)){const n=t.anode[s];t.nodeDef.params[s].handler?e[s]=this.paramHandlers[t.nodeDef.params[s].handler].param2json(t.anode):n instanceof AudioParam?void 0===n._value?e[s]=n.value:e[s]=n._value:e[s]=n}return{type:t.type,params:e,controlParam:t.controlParam,controlParams:t.controlParams}}midi2freqRatio(t){return Math.pow(c,t-h)}noteOn(t,e,s){s||(s=this.ac.currentTime);const n=this.midi2freqRatio(t);this.setupNoteHandlers();for(const o of this.noteHandlers)o.noteOn(t,e,n,s);this.portamento.ratio=n}noteOff(t,e,s){s||(s=this.ac.currentTime);for(const n of this.noteHandlers)n.noteOff(t,e,s)}addNoteHandler(t){this.noteHandlers.push(t)}removeNoteHandler(t){Object(a.d)(this.noteHandlers,t)}setupNoteHandlers(){let t=0;for(const e of this.noteHandlers)e.kbTrigger&&e.releaseTime>t&&(t=e.releaseTime);for(const e of this.noteHandlers)e.kbTrigger||(e.releaseTime=t)}initNodeParams(t,e,s){for(const n of Object.keys(e.params||{}))void 0===t[n]?console.warn(`Parameter '${n}' not found for node '${s}'`):t[n]instanceof AudioParam?t[n].value=e.params[n].initial:e.params[n].handler?(e.params[n].phandler=this.paramHandlers[e.params[n].handler],e.params[n].phandler.initialize(t,e)):t[n]=e.params[n].initial}registerCustomNode(t,e){this.customNodes[t]=(()=>new e(this.ac))}registerParamHandler(t,e){this.paramHandlers[t]=e}}},function(t,e,s){"use strict";function n(t,e,s,n){i.find(".popup-message").html(t),i.find(".modal-title").text(e||"Alert"),i.find(".popup-ok").hide(),s?i.find(".popup-close").hide():i.find(".popup-close").html("Close"),i.find(".popup-prompt > input").hide(),a=!0,i.one("hidden.bs.modal",t=>a=!1),i.modal(n)}function o(t,e,s,n){let o=!1;i.find(".popup-message").html(t),i.find(".modal-title").text(e||"Please confirm");const r=i.find(".popup-ok");r.show().click(t=>o=!0),i.find(".popup-prompt > input").hide(),i.find(".popup-close").text("Cancel"),i.one("shown.bs.modal",t=>{r.focus(),n&&n()}),i.find("form").one("submit",t=>(o=!0,r.click(),!1)),i.one("hide.bs.modal",t=>{r.off("click"),a=!1,s(o)}),a=!0,i.modal()}s.d(e,"d",function(){return a}),e.a=n,e.e=function(t,e){n(t,e,!0,{keyboard:!1})},e.b=function(){a&&i.find(".popup-ok").click()},e.c=o,e.f=function(t,e,s,n){const a=i.find(".popup-prompt > input");o(t,e,t=>{n&&n(t?a.val():null)},()=>{a.show(),a.focus(),s?(a.val(s),a[0].select()):a.val("")})};let a=!1;const i=$('\n\t<div class="normal-font modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">\n\t<div class="modal-dialog" role="document">\n\t\t<div class="modal-content">\n\t\t<div class="modal-header">\n\t\t\t<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n\t\t\t<h4 class="modal-title" id="myModalLabel"></h4>\n\t\t</div>\n\t\t<div class="modal-body">\n\t\t\t<div class="popup-message"></div>\n\t\t\t<form class="popup-prompt">\n\t\t\t\t<input type="text" style="width: 100%">\n\t\t\t</form>\n\t\t</div>\n\t\t<div class="modal-footer">\n\t\t\t<button type="button" class="btn btn-default popup-close" data-dismiss="modal"></button>\n\t\t\t<button type="button" class="btn btn-primary popup-ok" data-dismiss="modal">OK</button>\n\t\t</div>\n\t\t</div>\n\t</div>\n\t</div>\n');$("body").append(i)},function(t,e,s){"use strict";var n=s(0);class o{constructor(t){this.kbTrigger=!1,this.releaseTime=0,this.ndata=t,this.outTracker=new class{constructor(t){this.outputs=[],this.onBefore(t,"connect",this.connect,(t,e,s)=>{s[0].custom&&s[0].anode&&(s[0]=s[0].anode),t.apply(e,s)}),this.onBefore(t,"disconnect",this.disconnect)}connect(t){this.outputs.push(t)}disconnect(t){Object(n.d)(this.outputs,t)}onBefore(t,e,s,n){const o=t[e],a=this;t[e]=function(){s.apply(a,arguments),n?n(o,t,arguments):o.apply(t,arguments)}}}(t.anode)}noteOn(t,e,s,n){}noteOff(t,e,s){}clone(){const t=this.ndata.anode.context[this.ndata.nodeDef.constructor]();for(const e of Object.keys(this.ndata.nodeDef.params)){const s=this.ndata.anode[e];s instanceof AudioParam?t[e].value=s.value:null!==s&&void 0!==s&&(t[e]=s)}for(const e of this.outTracker.outputs){let s=e;s.custom&&s.anode&&(s=s.anode),t.connect(s)}for(const e of this.ndata.getInputs())e.anode.connect(t[e.controlParam]);return t}disconnect(t){for(const e of this.outTracker.outputs)t.disconnect(e);for(const e of this.ndata.getInputs())e.anode.disconnect(t[e.controlParam])}rampParam(t,e,s){const n=this.ndata.synth.portamento,o=t.value*e;if(t._value=o,n.time>0&&n.ratio>0){const e=t.value*n.ratio;t.cancelScheduledValues(s),t.linearRampToValueAtTime(e,s),t.exponentialRampToValueAtTime(o,s+n.time)}else t.setValueAtTime(o,s)}}class a extends o{noteOn(t,e,s,n){this.oscClone&&this.oscClone.stop(n),this.oscClone=this.clone(),this.rampParam(this.oscClone.frequency,s,n),this.oscClone.start(n),this.lastNote=t}noteOff(t,e,s){t==this.lastNote&&this.oscClone.stop(s+this.releaseTime)}}class i{constructor(t,e,s,n){this.v1=t,this.v2=e,this.t1=s,this.t2=n}inside(t){return this.t1<this.t2&&this.t1<=t&&t<=this.t2}cut(t){const e=this.v1+(this.v2-this.v1)*(t-this.t1)/(this.t2-this.t1);return new i(this.v1,e,this.t1,t)}run(t,e=!1){this.t2-this.t1<=0?t.setValueAtTime(this.v2,this.t2):(e||t.setValueAtTime(this.v1,this.t1),t.linearRampToValueAtTime(this.v2,this.t2))}}const r={osc:a,buffer:class extends o{noteOn(t,e,s,n){this.absn&&this.absn.stop(n);const o=this.ndata.anode._buffer;if(!o)return;this.absn=this.clone(),this.absn.buffer=o;const a=this.absn.playbackRate;a.value,this.rampParam(a,a.value*s,n),this.absn.start(n),this.lastNote=t}noteOff(t,e,s){t==this.lastNote&&this.absn.stop(s+this.releaseTime)}},ADSR:class extends o{constructor(t){super(t),this.kbTrigger=!0;const e=t.anode,s=e.disconnect;e.disconnect=(t=>{this.loopParams(s=>{s==t&&s.setValueAtTime(s._value,e.context.currentTime)}),s(t)})}get releaseTime(){return this.ndata.anode.release}noteOn(t,e,s,n){this.lastNote=t;const o=this.ndata.anode;this.loopParams(t=>{const e=this.getParamValue(t),s=(1-o.depth)*e,a=e*o.sustain+s*(1-o.sustain),r=o.context.currentTime;t.cancelScheduledValues(r),n>r&&this.rescheduleRamp(t,t._release,r),t._attack=new i(s,e,n,n+o.attack),t._decay=new i(e,a,n+o.attack,n+o.attack+o.decay),t._attack.run(t),t._decay.run(t,!0)})}noteOff(t,e,s){if(t!=this.lastNote)return;const n=this.ndata.anode;this.loopParams(t=>{let e=this.getRampValueAtTime(t,s);null===e&&(e=this.getParamValue(t)*n.sustain);const o=(1-n.depth)*e;t.cancelScheduledValues(s);const a=n.context.currentTime;s>a&&(this.rescheduleRamp(t,t._attack,a)||this.rescheduleRamp(t,t._decay,a)),t._release=new i(e,o,s,s+n.release),t._release.run(t)})}rescheduleRamp(t,e,s){return!(!e||!e.inside(s)||(e.cut(s).run(t),0))}getRampValueAtTime(t,e){return t._attack&&t._attack.inside(e)?t._attack.cut(e).v2:t._decay&&t._decay.inside(e)?t._decay.cut(e).v2:null}loopParams(t){for(const e of this.outTracker.outputs)e instanceof AudioParam&&t(e)}getParamValue(t){return void 0===t._value&&(t._value=t.value),t._value}},LFO:class extends a{rampParam(t,e,s){t.setValueAtTime(t.value,s)}},restartable:class extends o{constructor(){super(...arguments),this.playing=!1}noteOn(t,e,s,n){const o=this.ndata.anode;this.playing&&o.stop(n),this.playing=!0,o.start(n),this.lastNote=t}noteOff(t,e,s){t==this.lastNote&&(this.playing=!1,this.ndata.anode.stop(s+this.releaseTime))}},soundBank:class extends o{noteOn(t,e,s,n){const o=this.ndata.anode._buffers,a=this.clone();a.buffer=o[t%o.length],a.start(n)}noteOff(t,e,s){}}};e.a=r},function(t,e,s){"use strict";s.d(e,"a",function(){return o});const n={initial:0,min:-1200,max:1200,linear:!0};var o={Oscillator:{constructor:"createOscillator",noteHandler:"osc",params:{frequency:{initial:220,min:20,max:2e4},detune:n,type:{initial:"sawtooth",choices:["sine","square","sawtooth","triangle"]}}},Buffer:{constructor:"createBufferSource",noteHandler:"buffer",params:{playbackRate:{initial:1,min:0,max:8},detune:n,buffer:{initial:null,handler:"BufferDataHandler"},loop:{initial:!1},loopStart:{initial:0,min:0,max:10},loopEnd:{initial:3,min:0,max:10}}},Noise:{constructor:"createNoise",noteHandler:"restartable",custom:!0,params:{gain:{initial:1,min:0,max:10}}},LineIn:{constructor:"createLineIn",custom:!0,params:{}},SoundBank:{constructor:"createBufferSource",noteHandler:"soundBank",params:{buffer:{initial:null,handler:"SoundBankHandler"}}},Gain:{constructor:"createGain",params:{gain:{initial:1,min:0,max:10,linear:!0}}},Filter:{constructor:"createBiquadFilter",params:{frequency:{initial:440,min:20,max:2e4},Q:{initial:0,min:0,max:100},detune:n,gain:{initial:0,min:-40,max:40,linear:!0},type:{initial:"lowpass",choices:["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"]}}},Delay:{constructor:"createDelay",params:{delayTime:{initial:1,min:0,max:5}}},StereoPan:{constructor:"createStereoPanner",params:{pan:{initial:0,min:-1,max:1,linear:!0}}},Compressor:{constructor:"createDynamicsCompressor",params:{threshold:{initial:-24,min:-100,max:0,linear:!0},knee:{initial:30,min:0,max:40,linear:!0},ratio:{initial:12,min:1,max:20,linear:!0},reduction:{initial:0,min:-20,max:0,linear:!0},attack:{initial:.003,min:0,max:1},release:{initial:.25,min:0,max:1}}},Detuner:{constructor:"createDetuner",custom:!0,params:{octave:{initial:0,min:-2,max:2,linear:!0}}},LFO:{constructor:"createOscillator",noteHandler:"LFO",control:!0,params:{frequency:{initial:5,min:.01,max:200},detune:n,type:{initial:"sine",choices:["sine","square","sawtooth","triangle"]}}},GainCtrl:{constructor:"createGain",control:!0,params:{gain:{initial:10,min:0,max:100,linear:!0}}},ADSR:{constructor:"createADSR",noteHandler:"ADSR",control:!0,custom:!0,params:{attack:{initial:.2,min:0,max:10},decay:{initial:.5,min:0,max:10},sustain:{initial:.5,min:0,max:1,linear:!0},release:{initial:1,min:0,max:10},depth:{initial:1,min:0,max:1}}},NoiseCtrl:{constructor:"createNoiseCtrl",control:!0,custom:!0,params:{frequency:{initial:4,min:0,max:200},depth:{initial:20,min:0,max:200}}},Speaker:{constructor:null,params:{}}}},function(t,e,s){"use strict";class n{constructor(){this.custom=!0,this.channelCount=2,this.channelCountMode="max",this.channelInterpretation="speakers",this.numberOfInputs=0,this.numberOfOutputs=1}connect(t){}disconnect(t){}addEventListener(){}dispatchEvent(t){return!1}removeEventListener(){}}e.a=class extends n{constructor(){super(...arguments),this.attack=.2,this.decay=.5,this.sustain=.5,this.release=1,this.depth=1}};class o extends n{constructor(t){super(),this.gain=1,this.playing=!1,this.anode=t.createScriptProcessor(1024),this.anode.onaudioprocess=(t=>this.processAudio(t))}connect(t){this.anode.connect(t)}disconnect(){this.anode.disconnect()}start(){this.playing=!0}stop(){this.playing=!1}processAudio(t){}}e.e=class extends o{processAudio(t){for(let e=0;e<t.outputBuffer.numberOfChannels;e++){const s=t.outputBuffer.getChannelData(e);for(let t=0;t<s.length;t++)s[t]=this.playing?this.gain*(2*Math.random()-1):0}}};e.d=class extends o{constructor(t){super(t),this.ac=t,this.frequency=4,this.depth=20,this.sct=0,this.v=0}connect(t){this.anode.connect(t)}processAudio(t){const e=this.ac.sampleRate/this.frequency;for(let s=0;s<t.outputBuffer.numberOfChannels;s++){let n=t.outputBuffer.getChannelData(s);for(let t=0;t<n.length;t++)this.sct++,this.sct>e&&(this.v=this.depth*(2*Math.random()-1),this.sct=0),n[t]=this.v}}};e.b=class extends o{constructor(){super(...arguments),this.octave=0,this.numberOfInputs=1}processAudio(t){const e=Math.pow(2,this.octave);for(let s=0;s<t.outputBuffer.numberOfChannels;s++){let n=t.outputBuffer.getChannelData(s),o=t.inputBuffer.getChannelData(s),a=0;for(let t=0;t<n.length;t++)n[t]=o[Math.floor(a)],(a+=e)>=o.length&&(a=0)}}};e.c=class extends n{connect(t){if(this.srcNode)return this.srcNode.connect(t),void(this.dstNode=t);const e=window.navigator;e.getUserMedia=e.getUserMedia||e.webkitGetUserMedia||e.mozGetUserMedia||e.msGetUserMedia,e.getUserMedia({audio:!0},e=>{const s=t.context;this.srcNode=s.createMediaStreamSource(e);let n=t;n.custom&&n.anode&&(n=n.anode),this.srcNode.connect(n),this.dstNode=t,this.stream=e},t=>console.error(t))}disconnect(){this.srcNode.disconnect(this.dstNode)}}},function(t,e,s){"use strict";e.a=class{constructor(t,e=60,s=.1){this.running=!1,this.ac=t,this.noteDuration=0,this.nextNoteTime=0,this.bpm=e,this.ahead=s}get bpm(){return this._bpm}set bpm(t){this._bpm=t,this.nextNoteTime-=this.noteDuration,this.noteDuration=15/this._bpm,this.nextNoteTime+=this.noteDuration}start(t){this.running||(this.running=!0,t&&(this.cb=t),this.nextNoteTime=this.ac.currentTime,this.tick())}stop(){this.running=!1}tick(){if(this.running)for(requestAnimationFrame(this.tick.bind(this));this.nextNoteTime<this.ac.currentTime+this.ahead;)this.cb&&this.cb(this.nextNoteTime),this.nextNoteTime+=this.noteDuration}}},function(t,e,s){"use strict";var n=s(2);e.a=class{constructor(t,e,s,n){this.pressed=[],this.released=[],this.voices=[];for(let a=0;a<s;a++)this.voices.push(new o(t,e,n)),this.released.push(a);this.portamento=this.voices[0].synth.portamento,e.keyboard&&e.keyboard.portamento&&(this.portamento.time=e.keyboard.portamento);for(let t=1;t<s;t++)this.voices[t].synth.portamento=this.portamento}noteOn(t,e=1,s){const n=this.findVoice(),o=this.voices[n];this.pressed.push(n),o.noteOn(t,e,s)}noteOff(t,e=1,s){for(let n=0;n<this.voices.length;n++){const o=this.voices[n];if(o.lastNote==t){o.noteOff(t,e,s),this.released.push(n);break}}}allNotesOff(){for(const t of this.voices)t.lastNote&&t.noteOff(t.lastNote)}findVoice(){let t;if(this.released.length>0)t=this.released;else{if(!(this.pressed.length>0))throw"This should never happen";t=this.pressed}return t.splice(0,1)[0]}close(){for(const t of this.voices)t.close()}};class o{constructor(t,e,s){this.loader=new class{constructor(){this.nodes=[]}load(t,e,s){const o=new n.b(t);let i=0;for(const t of e.nodes)this.nodes[i++]=new a(t.id);for(let t=0;t<e.nodes.length;t++)for(const s of e.nodes[t].inputs)this.nodes[t].inputs.push(this.nodeById(s));for(let t=0;t<e.nodes.length;t++){const n=e.nodeData[t].type;"out"==n?o.initOutputNodeData(this.nodes[t],s):o.initNodeData(this.nodes[t],n),o.json2NodeData(e.nodeData[t],this.nodes[t])}for(const t of this.nodes)for(const e of t.inputs)o.connectNodes(e,t);return this.synth=o,o}nodeById(t){for(const e of this.nodes)if(e.id===t)return e;return null}close(){for(const t of this.nodes)for(const e of t.inputs)this.synth.disconnectNodes(e,t)}},this.synth=this.loader.load(t,e,s||t.destination),this.lastNote=0}noteOn(t,e=1,s){this.synth.noteOn(t,e,s),this.lastNote=t}noteOff(t,e=1,s){this.synth.noteOff(t,e,s),this.lastNote=0}close(){this.lastNote&&this.noteOff(this.lastNote,1),this.loader.close()}}e.b=o;class a extends n.a{constructor(t){super(),this.id=t,this.inputs=[]}getInputs(){return this.inputs}}},function(t,e,s){t.exports=s(10)},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=s(11),o=s(15),a=s(20);const i=$("#graph-canvas")[0],r=new(window.AudioContext||window.webkitAudioContext),c=new n.a(r,i,$("#node-params"),$("#audio-graph-fft"),$("#audio-graph-osc"));!function(){$(function(){$(".nano").nanoScroller({preventPageScrolling:!0})});const t=new o.a(c),e=new a.a(c);e.beforeSave=(e=>$.extend(e,{keyboard:t.piano.toJSON()})),e.afterLoad=(e=>t.piano.fromJSON(e.keyboard)),e.presets}()},function(t,e,s){"use strict";function n(t,e){const s=$("<div>").addClass(t);$("body").append(s);const n=s.css(e);return s.remove(),n}var o=s(12),a=s(2),i=s(0),r=s(3),c=s(13),h=s(14);e.a=class{constructor(t,e,s,d,l){this.gr=new o.a(e),this.gr.handler=new class{constructor(t,e,s,o){this.synthUI=t,this.jqParams=e,this.arrowColor=n("arrow","color"),this.ctrlArrowColor=n("arrow-ctrl","color"),this.registerNodeDelete(e.parent()[0]),this.analyzer=new h.a(s,o)}registerNodeDelete(t){$(Object(i.a)(t)).keydown(t=>{if(!(46==t.keyCode||8==t.keyCode&&t.metaKey))return;if(r.d)return;const e=this.getSelectedNode();e&&(e.data.isOut||r.c("Delete node?","Please confirm node deletion",t=>{t&&(this.synthUI.removeNode(e),this.jqParams.empty())}))})}getSelectedNode(){for(const t of this.synthUI.gr.nodes)if(t.element.hasClass("selected"))return t;return null}hasAudioParams(t){const e=Object.keys(t.nodeDef.params).filter(e=>t.anode[e]instanceof AudioParam);return e.length>0}canBeSource(t){const e=t.data;return e.anode!=this.synthUI.outNode}canConnect(t,e){const s=t.data,n=e.data;return s.nodeDef.control?this.hasAudioParams(n):n.anode.numberOfInputs>0}connected(t,e){this.synthUI.synth.connectNodes(t.data,e.data)}disconnected(t,e){this.synthUI.synth.disconnectNodes(t.data,e.data)}nodeSelected(t){const e=t.data;Object(c.a)(e,this.jqParams)}nodeRemoved(t){this.synthUI.removeNodeData(t.data)}getArrowColor(t,e){const s=t.data;return s.nodeDef.control?this.ctrlArrowColor:this.arrowColor}data2json(t){return this.synthUI.synth.nodeData2json(t.data)}json2data(t,e){this.synthUI.createNodeData(t,e.type),this.synthUI.synth.json2NodeData(e,t.data)}graphLoaded(){this.analyzer.analyze(this.synthUI.outNode)}graphSaved(){}}(this,s,d,l),this.synth=new a.b(t),this.registerPaletteHandler(),this.addOutputNode()}addOutputNode(){const t=new o.b(500,210,"Out");t.data=new d(t),this.synth.initOutputNodeData(t.data,this.synth.ac.destination),this.outNode=t.data.anode,this.gr.addNode(t,"node-out"),this.initNodeDimensions(t)}registerPaletteHandler(){var t=this;$(".palette .node").click(function(e){const s=$(this),n=s.attr("class").split(/\s+/).filter(t=>"node"!=t);t.addNode(s.attr("data-type"),s.find(".node-text").html(),n.join(" "))})}addNode(t,e,s){let{x:n,y:a}=this.findFreeSpot();const i=new o.b(n,a,e);this.createNodeData(i,t),this.gr.addNode(i,s),this.gr.selectNode(i)}removeNode(t){this.gr.removeNode(t)}removeNodeData(t){this.synth.removeNodeData(t)}createNodeData(t,e){t.data=new d(t),"out"==e?(this.synth.initOutputNodeData(t.data,this.synth.ac.destination),this.outNode=t.data.anode):this.synth.initNodeData(t.data,e)}findFreeSpot(){let t=0;const e=this.gr.canvas.width,s=this.gr.canvas.height;let n=e/2,o=s/2;for(let a=10;a<e-this.nw;a+=10)for(let e=10;e<s-this.nh;e+=10){const s=this.dist2nearestNode(a,e);s>t&&s<3*this.nw&&(n=a,o=e,t=s)}return{x:n,y:o}}dist2nearestNode(t,e){let s=Number.MAX_VALUE;for(const n of this.gr.nodes){const o=t-n.x,a=e-n.y,i=Math.sqrt(o*o+a*a);i<s&&(s=i)}return s}initNodeDimensions(t){this.nw=t.element.outerWidth(),this.nh=t.element.outerHeight()}};class d extends a.a{constructor(t){super(),this.node=t}getInputs(){const t=[];for(const e of this.node.inputs)t.push(e.data);return t}}},function(t,e,s){"use strict";const n=16,o=20;e.a=class{constructor(t){this.nodes=[],this.lastId=0,this.nodeCanvas=$(t.parentElement),this.canvas=t;const e=t.getContext("2d");this.graphDraw=new class{constructor(t,e,s){this.arrowHeadLen=10,this.graph=t,this.gc=e,this.canvas=s,this.nodes=t.nodes}draw(){this.clearCanvas(),this.gc.lineWidth=2;for(const t of this.nodes)for(const e of t.inputs)this.drawArrow(e,t)}clearCanvas(){this.gc.clearRect(0,0,this.canvas.width,this.canvas.height)}drawArrow(t,e){const s=this.getNodeCenter(t),n=this.getNodeCenter(e);this.gc.strokeStyle=this.graph.handler.getArrowColor(t,e),this.gc.beginPath(),this.gc.moveTo(s.x,s.y),this.gc.lineTo(n.x,n.y),this.drawArrowTip(s,n),this.gc.closePath(),this.gc.stroke()}drawArrowTip(t,e){const s=t.x+.6*(e.x-t.x),n=t.y+.6*(e.y-t.y);var o=Math.atan2(e.y-t.y,e.x-t.x);this.gc.moveTo(s,n),this.gc.lineTo(s-this.arrowHeadLen*Math.cos(o-Math.PI/6),n-this.arrowHeadLen*Math.sin(o-Math.PI/6)),this.gc.moveTo(s,n),this.gc.lineTo(s-this.arrowHeadLen*Math.cos(o+Math.PI/6),n-this.arrowHeadLen*Math.sin(o+Math.PI/6))}getNodeCenter(t){return t.w=void 0!==t.w?t.w:t.element.outerWidth(),t.h=void 0!==t.h?t.h:t.element.outerHeight(),{x:t.x+t.w/2,y:t.y+t.h/2}}}(this,e,t),this.graphInteract=new class{constructor(t,e){this.dragging=!1,this.graph=t,this.gc=e,this.setupConnectHandler(e.canvas)}registerNode(t){t.element.draggable({containment:"parent",distance:5,stack:".node",drag:(e,s)=>{t.x=s.position.left,t.y=s.position.top,this.graph.draw()},start:(t,e)=>{this.dragging=!0,e.helper.css("cursor","move")},stop:(t,e)=>{e.helper.css("cursor","default"),this.dragging=!1}}),t.element.click(e=>{this.dragging||this.selectedNode!=t&&this.selectNode(t)})}selectNode(t){this.selectedNode&&this.selectedNode.element.removeClass("selected"),t.element.addClass("selected"),this.selectedNode=t,this.graph.handler.nodeSelected(t)}setupConnectHandler(t){let e,s=!1;for(;t.tabIndex<0&&"body"!=t.nodeName.toLowerCase();)t=t.parentElement;$(t).keydown(t=>{if(t.keyCode==o)return this.setGrid([20,20]);t.keyCode!=n||s||(e=this.getNodeFromDOM(this.getElementUnderMouse()))&&(this.graph.handler.canBeSource(e)?(s=!0,this.registerRubberBanding(e)):e.element.css("cursor","not-allowed"))}).keyup(t=>{if(t.keyCode==o)return this.setGrid(null);if(t.keyCode!=n)return;s=!1,this.deregisterRubberBanding();const a=this.getNodeFromDOM(this.getElementUnderMouse());a&&e!=a&&(this.connectOrDisconnect(e,a),this.graph.draw())})}setGrid(t){$(this.graph.nodeCanvas).find(".node").draggable("option","grid",t)}connectOrDisconnect(t,e){this.graph.disconnect(t,e)||this.graph.connect(t,e)}getElementUnderMouse(){const t=$(":hover");if(t.length<=0)return null;const e=$(t.get(t.length-1));return e.hasClass("node")?e:e.parent().hasClass("node")?e.parent():null}registerRubberBanding(t){const e=this.graph.nodeCanvas.offset(),s=new a(0,0,"");s.w=0,s.h=0,$(this.graph.nodeCanvas).on("mousemove",n=>{s.x=n.clientX-e.left,s.y=n.clientY-e.top+$("body").scrollTop(),this.graph.draw(),this.gc.save(),this.gc.setLineDash([10]),this.graph.graphDraw.drawArrow(t,s),this.gc.restore()}),this.graph.nodeCanvas.css("cursor","crosshair"),this.graph.nodeCanvas.find(".node").css("cursor","crosshair");for(const e of this.graph.nodes)e==t||this.graph.handler.canConnect(t,e)||e.element.css("cursor","not-allowed")}deregisterRubberBanding(){this.graph.nodeCanvas.css("cursor",""),this.graph.nodeCanvas.find(".node").css("cursor","default"),this.graph.nodeCanvas.off("mousemove"),this.graph.graphDraw.draw()}getNodeFromDOM(t){if(!t)return null;for(const e of this.graph.nodes)if(e.element[0]==t[0])return e;return null}}(this,e),this.handler=new i}addNode(t,e){t.id=this.lastId++,t.element=$("<div>").addClass("node").html(`<div class="node-text">${t.name}</div>`).css({left:t.x,top:t.y,cursor:"default"}),e&&t.element.addClass(e),this.nodeCanvas.append(t.element),this.nodes.push(t),this.graphInteract.registerNode(t),this.draw()}removeNode(t){const e=this.nodes.indexOf(t);if(e<0)return console.warn(`Node '${t.name}' is not a member of graph`);for(const e of this.nodes)t!=e&&(this.disconnect(t,e),this.disconnect(e,t));this.nodes.splice(e,1),t.element.remove(),this.handler.nodeRemoved(t),this.draw()}selectNode(t){this.graphInteract.selectNode(t)}connect(t,e){return!(!this.handler.canBeSource(t)||!this.handler.canConnect(t,e)||(e.addInput(t),this.handler.connected(t,e),0))}disconnect(t,e){return!!e.removeInput(t)&&(this.handler.disconnected(t,e),!0)}draw(){this.graphDraw.draw()}toJSON(){const t=[],e=[];for(const s of this.nodes){const n=[];for(const t of s.inputs)n.push(t.id);t.push({id:s.id,x:s.x,y:s.y,name:s.name,inputs:n,classes:this.getAppClasses(s)}),e.push(this.handler.data2json(s))}const s={nodes:t,nodeData:e};return this.handler.graphSaved(),s}fromJSON(t){for(;this.nodes.length>0;)this.removeNode(this.nodes[0]);this.lastId=0;for(const e of t.nodes){const t=new a(e.x,e.y,e.name);this.addNode(t),t.id=e.id,t.element.attr("class",e.classes)}const e=this.handler;this.handler=new i;for(let e=0;e<t.nodes.length;e++)for(const s of t.nodes[e].inputs){const t=this.nodeById(s);this.connect(t,this.nodes[e])}this.handler=e;for(let e=0;e<t.nodes.length;e++)this.handler.json2data(this.nodes[e],t.nodeData[e]);for(const t of this.nodes)for(const e of t.inputs)this.handler.connected(e,t);this.draw(),this.handler.graphLoaded()}nodeById(t){for(const e of this.nodes)if(e.id===t)return e;return null}getAppClasses(t){const e=t.element[0].className.split(/\s+/),s=[];for(const t of e)"selected"!=t&&"ui-"!=t.substr(0,3)&&s.push(t);return s.join(" ")}};class a{constructor(t,e,s){this.inputs=[],this.x=t,this.y=e,this.name=s.replace(/<[^<]*>/g,t=>"<br>"==t?t:"")}addInput(t){this.inputs.push(t)}removeInput(t){const e=this.inputs.indexOf(t);return!(e<0)&&(this.inputs.splice(e,1),!0)}}e.b=a;class i{canBeSource(t){return!0}canConnect(t,e){return!0}connected(t,e){}disconnected(t,e){}nodeSelected(t){}nodeRemoved(t){}getArrowColor(t,e){return"black"}data2json(t){return{}}json2data(t,e){}graphLoaded(){}graphSaved(){}}},function(t,e,s){"use strict";function n(t,e,s,n,o){const i=$('<div class="slider-box">'),d=$('<input type="range" orient="vertical">').attr("min",0).attr("max",1).attr("step",.001).attr("value",a(n,e)),l=$('<input type="number">').attr("min",e.min).attr("max",e.max).attr("value",c(n,5));return i.append(l),i.append(d),i.append($("<span><br/>"+r(s)+"</span>")),t.append(i),d.on("input",t=>{const s=function(t,e){return e.linear?e.min+t*(e.max-e.min):Object(h.c)(t,e.min,e.max)}(parseFloat(d.val()),e);l.val(c(s,5)),o(s)}),l.on("input",t=>{const s=parseFloat(l.val());isNaN(s)||(d.val(a(s,e)),o(s))}),i}function o(t,e,s,n){const o=$('<div class="choice-box">'),a=$("<select>").attr("size",e.length||2);for(const t of e){const e=$("<option>").text(t);t==s&&e.attr("selected","selected"),a.append(e)}return o.append(a),a.after("<br/><br/>"+n),t.append(o),a}function a(t,e){return e.linear?(t-e.min)/(e.max-e.min):Object(h.b)(t,e.min,e.max)}function i(t,e){t.empty();for(const s of e)t.append("<option>"+s+"</option>")}function r(t){return t[0].toUpperCase()+t.substring(1)}function c(t,e){let s=""+t;return"."==(s=s.substr(0,e))[s.length-1]?s.substr(0,e-1):s}e.a=function(t,e){e.empty();const s=[];t.nodeDef.control&&t.controlParams&&s.push(function(t,e){if(!t.controlParams)return;const s=o(e,t.controlParams,t.controlParam,"Controlling");return s.change(e=>{t.controlParam&&t.anode.disconnect(t.controlTarget[t.controlParam]),t.controlParam=s.val(),t.anode.connect(t.controlTarget[t.controlParam])}),s.parent()}(t,e));const a=Object.keys(t.nodeDef.params||{});if(!(a.length<=0)){for(const i of a)t.anode[i]instanceof AudioParam?s.push(function(t,e,s,o){const a=e.params[s],i=t[s];return i._value&&(i.value=i._value),n(o,a,s,i.value,t=>{i.value=t,i._value=t})}(t.anode,t.nodeDef,i,e)):s.push(function(t,e,s,a){const i=e.params[s];if(i.choices){const e=o(a,i.choices,t[s],r(s));return e.change(n=>{t[s]=e.val()}),e.parent()}return void 0!=i.min?n(a,i,s,t[s],e=>t[s]=e):"boolean"==typeof i.initial?function(t,e,s,n,o){const a=$('<div class="choice-box">'),i=$('<button class="btn btn-info" data-toggle="button" aria-pressed="false">');return a.append(i),i.after("<br/><br/>"+o),t.append(a),n[s]?(i.text("Enabled"),i.addClass("active"),i.attr("aria-pressed","true")):(i.text("Disabled"),i.removeClass("active"),i.attr("aria-pressed","false")),i.click(t=>{n[s]=!n[s],i.text(n[s]?"Enabled":"Disabled")}),a}(a,0,s,t,r(s)):i.phandler?u[i.phandler.uiRender](a,i,t,s,r(s)):void 0}(t.anode,t.nodeDef,i,e));!function(t,e){const s=t.width(),n=e[0].width(),o=(s-e.length*n)/(e.length+1);let a=o;for(const t of e)t.css({position:"relative",left:a}),a+=o}(e,s)}};var h=s(0),d=s(1),l=s(3);const u={renderBufferData:function(t,e,s,n,o){const a=$('<div class="choice-box">'),i=$('\n\t\t<span class="btn btn-primary upload">\n\t\t\t<input type="file">\n\t\t\tLoad&nbsp;\n\t\t\t<span class="glyphicon glyphicon-open" aria-hidden="true"></span>\n\t\t</span>');a.append(i),i.after("<br/><br/>"+o),t.append(a);let r=!0;return i.find("input").change(t=>{d.e(t,t=>{s._encoded=t,s.context.decodeAudioData(t,t=>{s._buffer=t,r=!1,l.b()})}),setTimeout(t=>{r&&l.e("Loading and decoding audio data...")},300)}),a},renderSoundBank:function(t,e,s,n,a){const r=o(t,[],"","Buffers");r.css({marginBottom:"10px",marginLeft:"-20px",width:"140px",height:"100px",overflowX:"auto"});const c=$('<div style="margin-bottom: -24px">\n\t\t<span class="btn btn-primary upload">\n\t\t\t<input type="file">\n\t\t\t<span class="glyphicon glyphicon-open" aria-hidden="true"></span>\n\t\t</span>\n\t\t&nbsp;&nbsp;&nbsp;\n\t\t<span class="btn btn-danger">\n\t\t\t<span class="glyphicon glyphicon-trash" aria-hidden="true"></span>\n\t\t</span></div>');r.after(c);const h=s._buffers,l=s._encodedBuffers,u=s._names;return i(r,u),c.find("input").change(t=>{d.e(t,(t,e)=>{l.push(t),s.context.decodeAudioData(t,t=>h.push(t)),u.push(e.name),i(r,u)})}),c.find(".btn-danger").click(t=>{const e=u.indexOf(r.val());e<0||([l,h,u].forEach(t=>t.splice(e,1)),i(r,u))}),r.parent()}}},function(t,e,s){"use strict";e.a=class{constructor(t,e){this.canvasFFT=this.createCanvas(t),this.gcFFT=this.canvasFFT.getContext("2d"),this.canvasOsc=this.createCanvas(e),this.gcOsc=this.canvasOsc.getContext("2d")}createCanvas(t){const e=$(`<canvas width="${t.width()}" height="${t.height()}">`);return t.append(e),e[0]}createAnalyzerNode(t){this.anode||(this.anode=t.createAnalyser(),this.fftData=new Uint8Array(this.anode.fftSize),this.oscData=new Uint8Array(this.anode.fftSize))}analyze(t){this.disconnect(),this.createAnalyzerNode(t.context),this.input=t,this.input.connect(this.anode),this.requestAnimationFrame()}disconnect(){this.input&&(this.input.disconnect(this.anode),this.input=null)}requestAnimationFrame(){window.requestAnimationFrame(t=>this.updateCanvas())}updateCanvas(){this.input&&(this.drawFFT(this.gcFFT,this.canvasFFT,this.fftData,"#00FF00"),this.drawOsc(this.gcOsc,this.canvasOsc,this.oscData,"#FFFF00"),this.requestAnimationFrame())}drawFFT(t,e,s,n){const[o,a]=this.setupDraw(t,e,s,n);this.anode.getByteFrequencyData(s);const i=s.length/2/e.width;let r=0;for(let e=0;e<o;e++){let n=s[Math.floor(r)];r+=i,t.moveTo(e,a-1),t.lineTo(e,a-1-a*n/256)}t.stroke(),t.closePath()}drawOsc(t,e,s,n){const[o,a]=this.setupDraw(t,e,s,n);this.anode.getByteTimeDomainData(s),t.moveTo(0,a/2);let i=0;for(;s[i]>128&&i<s.length/4;)i++;for(;s[i]<128&&i<s.length/4;)i++;const r=.75*s.length/e.width;for(let e=0;e<o;e++){let n=s[Math.floor(i)];i+=r,t.lineTo(e,a*n/256)}t.stroke(),t.closePath()}setupDraw(t,e,s,n){const o=e.width,a=e.height;return t.clearRect(0,0,o,a),t.beginPath(),t.strokeStyle=n,[o,a]}}},function(t,e,s){"use strict";var n=s(16),o=s(17),a=s(18),i=s(19),r=s(8);const c=8;e.a=class{constructor(t){this.synthUI=t,this.poly=!1;var e=new a.a($("#piano"));this.piano=e,e.noteOn=(t=>this.arpeggiator.sendNoteOn(t,1)),e.noteOff=(t=>this.arpeggiator.sendNoteOff(t,1)),e.polyOn=(()=>this.polyOn()),e.polyOff=(()=>this.polyOff());var s=this.setupPCKeyboard(e);s.baseNote=e.baseNote,e.octaveChanged=(t=>s.baseNote=t),this.setupEnvelopeAnimation(e),this.setupArpeggiator(e,t.synth.ac),this.setupMidiKeyboard(e)}setupPCKeyboard(t){var e=new n.a("#synth");return e.noteOn=(e=>{"INPUT"==document.activeElement.nodeName&&"range"!=document.activeElement.getAttribute("type")||(this.arpeggiator.sendNoteOn(e,1),t.displayKeyDown(e))}),e.noteOff=(e=>{this.arpeggiator.sendNoteOff(e,1),t.displayKeyUp(e)}),e}setupMidiKeyboard(t){var e=new o.a;e.noteOn=((e,s,n)=>{this.arpeggiator.sendNoteOn(e,1),t.displayKeyDown(e)}),e.noteOff=((e,s,n)=>{this.arpeggiator.sendNoteOff(e,1),t.displayKeyUp(e)})}setupEnvelopeAnimation(t){const e=this.synthUI.gr.handler.graphLoaded;this.synthUI.gr.handler.graphLoaded=function(){e.bind(this.synthUI.gr.handler)();let s=null;for(const t of this.synthUI.gr.nodes){const e=t.data;if("ADSR"==e.type){s=e.anode;break}}t.setEnvelope(s||{attack:0,release:0})}}setupArpeggiator(t,e){this.arpeggiator=new i.a(e),t.arpeggioChanged=((t,e,s)=>{this.arpeggiator.mode=e,this.arpeggiator.octaves=s,this.arpeggiator.bpm=t}),this.arpeggiator.noteOn=((t,e,s)=>this.noteOn(t,e,s)),this.arpeggiator.noteOff=((t,e,s)=>this.noteOff(t,e,s))}noteOn(t,e,s){this.lastNote=t;const n=this.piano.getPortamento();this.poly?(this.instrument.portamento.time=n,this.instrument.noteOn(t,e,s)):(this.synthUI.synth.portamento.time=n,this.synthUI.synth.noteOn(t,e,s))}noteOff(t,e,s){this.lastNote=0,this.poly?this.instrument.noteOff(t,e,s):this.synthUI.synth.noteOff(t,e,s)}polyOn(){this.lastNote&&this.noteOff(this.lastNote,1),this.poly=!0;const t=this.synthUI.gr.toJSON();this.instrument=new r.a(this.synthUI.synth.ac,t,c)}polyOff(){this.poly=!1,this.instrument.close()}}},function(t,e,s){"use strict";const n="ZSXDCVGBHNJMQ2W3ER5T6Y7UI9O0P",o=36;e.a=class{constructor(t="body"){this.setupHandler(t),this.baseNote=o}setupHandler(t){const e={};$(t).on("keydown",t=>{if(e[t.keyCode])return;if(t.metaKey||t.altKey||t.ctrlKey)return;e[t.keyCode]=!0;const s=this.key2midi(t.keyCode);s<0||this.noteOn(s)}).on("keyup",t=>{e[t.keyCode]=!1;const s=this.key2midi(t.keyCode);s<0||this.noteOff(s)})}key2midi(t){const e=n.indexOf(String.fromCharCode(t));return e<0?-1:this.baseNote+e}noteOn(t){}noteOff(t){}}},function(t,e,s){"use strict";e.a=class{constructor(){this.connected=!1,navigator.requestMIDIAccess&&navigator.requestMIDIAccess({sysex:!1}).then(t=>{if(t.inputs.size<=0)return;const e=t.inputs.values().next().value;e&&(e.onmidimessage=(t=>this.midiMessage(t)),this.connected=!0)})}midiMessage(t){const e=t.data,s=e[0]>>4,n=15&e[0],o=e[1],a=e[2];switch(s){case 9:this.noteOn(o,a,n);break;case 8:this.noteOff(o,a,n)}}noteOn(t,e,s){}noteOff(t,e,s){}}},function(t,e,s){"use strict";var n=s(3),o=s(0);const a=17,i=36,r=["","u","d","ud"],c=["-","&uarr;","&darr;","&uarr;&darr;"],h=3,d=15,l=480,u=0,p=1;class f{constructor(t=a){this.numWhites=t}createKeys(t){const e=[],s=t.width(),n=t.height(),o=parseFloat(t.css("padding-left")),a=parseFloat(t.css("padding-top")),i=s/this.numWhites+1,r=Math.round(2*i/3),c=Math.round(2*n/3);let h=0;for(let s=0;s<this.numWhites;s++){const o=$('<div class="piano-key">').css({width:i+"px",height:n+"px"});t.append(o),e[h++]=o,this.hasBlack(s)&&h++}h=0;let d=o-r/2;for(let s=0;s<this.numWhites-1;s++){if(d+=i-1,h++,!this.hasBlack(s))continue;const n=$('<div class="piano-key piano-black">').css({width:r+"px",height:c+"px",left:d+"px",top:a+"px"});t.append(n),e[h++]=n}return e}hasBlack(t){const e=t%7;return 2!=e&&6!=e}}e.a=class{constructor(t){this.arpeggio={mode:0,octave:1,bpm:60},this.baseNote=i,this.octave=3,this.poly=!1,this.envelope={attack:0,release:0};const e=new f;this.keys=e.createKeys(t);for(let t=0;t<this.keys.length;t++)this.registerKey(this.keys[t],t);this.controls=t.parent(),this.registerButtons(this.controls),this.portaSlider=this.controls.find(".portamento-box input")}registerKey(t,e){t.mousedown(s=>{const n=e+this.baseNote;this.displayKeyDown(t),this.noteOn(n)}),t.mouseup(s=>{const n=e+this.baseNote;this.displayKeyUp(t),this.noteOff(n)})}registerButtons(t){$("#prev-octave-but").click(t=>{this.octave--,this.updateOctave()}),$("#next-octave-but").click(t=>{this.octave++,this.updateOctave()});const e=t.find(".arpeggio-box input");e.on("input",t=>{this.arpeggio.bpm=Object(o.c)(parseFloat(e.val()),d,l),this.triggerArpeggioChange()});const s=t.find(".btn-arpeggio-ud");s.click(t=>this.changeArpeggioMode(s));const n=t.find(".btn-arpeggio-oct");n.click(t=>this.changeArpeggioOctave(n)),$("#poly-but").click(t=>this.togglePoly())}updateOctave(){$("#prev-octave-but").prop("disabled",this.octave<=1),$("#next-octave-but").prop("disabled",this.octave>=8),$("#octave-label").text("C"+this.octave),this.baseNote=i+12*(this.octave-3),this.octaveChanged(this.baseNote)}displayKeyDown(t){"number"==typeof t&&(t=this.midi2key(t)),t&&(!this.poly&&0==this.arpeggio.mode&&this.lastKey&&this.displayKeyUp(this.lastKey,!0),t.css("transition",`background-color ${this.envelope.attack}s linear`),t.addClass("piano-key-pressed"),this.lastKey=t)}displayKeyUp(t,e){if("number"==typeof t&&(t=this.midi2key(t)),!t)return;const s=e?0:this.envelope.release;t.css("transition",`background-color ${s}s linear`),t.removeClass("piano-key-pressed")}midi2key(t){return this.keys[t-this.baseNote]}setEnvelope(t){this.envelope=t}togglePoly(){if(this.poly=!this.poly,this.poly){const t=$("<div>").addClass("editor-cover");t.append("<p>You can use the PC keyboard to play notes<br><br>Synth editing is disabled in polyphonic mode</p>"),$("body").append(t),$("#poly-but").text("Poly"),n.d=!0,this.polyOn()}else $(".editor-cover").remove(),$("#poly-but").text("Mono"),n.d=!1,this.polyOff()}getPortamento(){const t=parseFloat(this.portaSlider.val());return Object(o.c)(t,u,p)}changeArpeggioMode(t){this.arpeggio.mode++,this.arpeggio.mode>=r.length&&(this.arpeggio.mode=0),t.html(c[this.arpeggio.mode]),this.triggerArpeggioChange()}changeArpeggioOctave(t){this.arpeggio.octave++,this.arpeggio.octave>h&&(this.arpeggio.octave=1),t.text(this.arpeggio.octave),this.triggerArpeggioChange()}triggerArpeggioChange(){this.arpeggioChanged(this.arpeggio.bpm,r[this.arpeggio.mode],this.arpeggio.octave)}toJSON(){return{portamento:this.getPortamento(),octave:this.octave,arpeggio:{bpm:this.arpeggio.bpm,mode:this.arpeggio.mode,octave:this.arpeggio.octave}}}fromJSON(t){t&&(t.portamento&&this.portaSlider.val(Object(o.b)(t.portamento,u,p)),t.octave&&(this.octave=t.octave,this.updateOctave()),t.arpeggio&&(this.arpeggio.bpm=t.arpeggio.bpm,this.arpeggio.mode=t.arpeggio.mode,this.arpeggio.octave=t.arpeggio.octave,this.controls.find(".arpeggio-box input").val(Object(o.b)(this.arpeggio.bpm,d,l)),this.controls.find(".btn-arpeggio-ud").html(c[this.arpeggio.mode]),this.controls.find(".btn-arpeggio-oct").text(this.arpeggio.octave),this.triggerArpeggioChange()))}noteOn(t){}noteOff(t){}polyOn(){}polyOff(){}octaveChanged(t){}arpeggioChanged(t,e,s){}}},function(t,e,s){"use strict";var n=s(7);e.a=class{constructor(t){this.backward=!1,this.noteOnTime=.75,this.mode="",this.octaves=1,this.bpm=60,this.notect=0,this.notes=new class{constructor(){this.notes=[]}length(){return this.notes.length}get(t){return this.notes[t]}add(t,e,s){const n=new o(t,e,s);for(let t=0;t<this.notes.length;t++)if(e<this.notes[t].noteToPlay)return void this.notes.splice(t,0,n);this.notes.push(n)}remove(t){this.notes=this.notes.filter(e=>e.note!=t)}},this.timer=new n.a(t,this.bpm)}get bpm(){return this._bpm}set bpm(t){this._bpm=t,this.timer&&(this.timer.bpm=t)}timerCB(t){if(0==this.mode.length)return;const e=this.notes.length();if(0==e)return;this.wrapCounter(e);const s=this.notes.get(this.notect);this.noteOn(s.noteToPlay,s.velocity,t),this.noteOff(s.noteToPlay,s.velocity,t+this.timer.noteDuration*this.noteOnTime),"u"==this.mode?this.notect++:"d"==this.mode?this.notect--:"ud"==this.mode&&(this.backward?this.notect--:this.notect++)}wrapCounter(t){this.notect>=t?"ud"!=this.mode?this.notect=0:(this.backward=!0,this.notect=t<2?0:t-2):this.notect<0&&("ud"!=this.mode?this.notect=t-1:(this.backward=!1,this.notect=t<2?0:1))}sendNoteOn(t,e){if(0==this.mode.length)return this.noteOn(t,e);const s=0==this.notes.length();this.notes.add(t,t,e),this.octaves>1&&this.notes.add(t,t+12,e),this.octaves>2&&this.notes.add(t,t+24,e),s&&this.timer.start(t=>this.timerCB(t))}sendNoteOff(t,e){0==this.mode.length&&this.noteOff(t,e),this.notes.remove(t),0==this.notes.length()&&(this.timerCB(0),this.timer.stop(),this.backward=!1,this.notect=0)}noteOn(t,e,s){}noteOff(t,e,s){}};class o{constructor(t,e,s){this.note=t,this.noteToPlay=e,this.velocity=s}}},function(t,e,s){"use strict";var n=s(3),o=s(1),a=s(0);const i=20;e.a=class{constructor(t){this.presetNum=0,this.synthUI=t,this.registerListeners(t.gr.canvas),this.loadPresets()}loadPresets(){this.presets=new Array(i);for(let t=0;t<i;t++)this.presets[t]=this.getEmptyPreset();$.get("js/presets.json",t=>{if(t instanceof Array){for(let e=0;e<i;e++)t[e]&&(this.presets[e]=t[e]);this.preset2synth()}})}getEmptyPreset(){return{name:"",nodes:[{id:0,x:500,y:180,name:"Out",inputs:[],classes:"node node-out"}],nodeData:[{type:"out",params:{}}]}}registerListeners(t){$("#save-but").click(t=>this.savePreset()),$("#load-file").on("change",t=>this.loadPreset(t)),$("#prev-preset-but").click(t=>this.changePreset(this.presetNum-1)),$("#next-preset-but").click(t=>this.changePreset(this.presetNum+1)),$(Object(a.a)(t)).keydown(t=>{"INPUT"==t.target.nodeName||n.d||(37==t.keyCode&&this.changePreset(this.presetNum-1),39==t.keyCode&&this.changePreset(this.presetNum+1))}),$("#preset-num").click(t=>this.togglePresetSelector());const e=$(".preset-selector select");e.change(t=>{const s=e.val().split(":")[0];this.changePreset(s-1)})}togglePresetSelector(){const t=$(".preset-selector");if(t.toggle(),!t.is(":visible"))return;this.synth2preset();const e=t.find("select");e.empty(),e.focus();let s=0;for(const t of this.presets){const n=s==this.presetNum?" selected":"";s++,t.nodes.length>1&&e.append(`<option${n}>${s}: ${t.name}</option>`)}}changePreset(t){t<0?t=i-1:t>=i&&(t=0),this.synth2preset(),this.presetNum=t,this.preset2synth()}synth2preset(){const t=this.synthUI.gr.toJSON();return t.name=$("#preset-name").val().trim(),t.modulatorType="synth",this.beforeSave(t),this.presets[this.presetNum]=t,t}preset2synth(){const t=this.presets[this.presetNum];this.afterLoad(t),$("#preset-num").text(this.presetNum+1),$("#preset-name").val(t.name),$("#node-params").empty(),this.synthUI.gr.fromJSON(t),this.selectBestNode()}selectBestNode(){const t=t=>this.synthUI.gr.nodes.filter(t)[0];let e=t(t=>"Filter"==t.data.type);e||(e=t(t=>"ADSR"==t.data.type)),e||(e=t(t=>0==t.data.anode.numberOfInputs)),e&&this.synthUI.gr.selectNode(e)}loadPreset(t){o.f(t,t=>{try{const e=JSON.parse(t);if("synth"!=e.modulatorType)throw"Invalid file format";this.presets[this.presetNum]=e,this.preset2synth()}catch(t){console.error(t),n.a("Could not load synth: invalid file format","Load error")}})}savePreset(){const t=this.synth2preset(),e=JSON.stringify(t);o.c()?(0==t.name.length&&(t.name=""+this.presetNum),o.d(t.name+".json",e)):n.f("Copy the text below to the clipboard and save it to a local text file","Save preset",e,null)}beforeSave(t){}afterLoad(t){}}}]);